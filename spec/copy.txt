Copy Feature
============

Copies processed documents to their designated location in the docstore.
Implemented in: workflows/filing.py


Command Line Options
--------------------

--copy
  Enable copy mode. After analysis (or cache hit), copy file to docstore.

--verify
  Use with --copy. Verify files exist at destination before skipping.
  Without this, trusts the database (fewer network calls).


Copy Logic Flow
---------------

After analyzing a file (or retrieving from cache):

1. If --copy not set → done (no copying)

2. If already copied (DB says copied=True):
   a. If --verify not set → skip (trust DB)
   b. If --verify set:
      - Check if dest_path exists in docstore
      - If exists → done
      - If missing → re-copy

3. If path changed (DB has different suggested_path):
   - Move file from old location to new location
   - Update DB with new dest_path

4. If not yet copied:
   a. Generate filename: "{title} {year}.pdf"
   b. Sanitize via storage driver: docstore.sanitize_filename(name)
   c. Check if filename exists at destination
   d. If collision, add hash suffix: "{title} {year} [{hash8}].pdf"
   e. Copy file to docstore
   f. Update DB: copied=True, dest_path=actual_path


Filename Generation
-------------------

Location: workflows/filing.py (private helper functions)

Base format:    "{title} {year}.pdf"
Collision:      "{title} {year} [{hash_prefix}].pdf"

Examples:
  - "Bank Statement 2024.pdf"
  - "Tax Return 2023 [a1b2c3d4].pdf"

The hash_prefix is first 8 characters of SHA256.


Company Folder Resolution
-------------------------

Before copying, company folder names are resolved to prevent duplicates
(e.g., "JPMorgan" vs "J.P. Morgan").

Location: workflows/folder_matcher.py

Process:
  1. Check if suggested_path ends in a "By company" folder
  2. List existing folders in parent directory
  3. Use LLM to check for matching company names
  4. If match found, use existing folder name instead


Database Updates
----------------

MetadataCache fields used by copy feature:

  source      Where file came from (for tracking)
  copied      1 if file has been copied to docstore
  dest_path   Actual destination path including filename

After successful copy:
  cache.update_copied(sha256, dest_path)


Idempotency
-----------

Copy operation is idempotent:

  - Same file → only copied once (hash-based identity)
  - Different files, same name → different filenames (hash suffix)
  - DB lost → files discovered by existence check, DB updated
  - Re-run with --verify → validates and repairs

SHA256 hash determines file identity:
  - Same content = same hash = same destination
  - Different content = different hash = different destination


Implementation Notes
--------------------

The copy logic in workflows/filing.py:

  class FilingWorkflow:
      def _copy_file(self, local_path, metadata, file_hash):
          # Generate sanitized filename
          name = self._generate_filename(metadata['title'], metadata['year'])
          name = self.docstore.sanitize_filename(name)

          # Resolve company folder if applicable
          dest_folder = resolve_company_folder(
              metadata['suggested_path'],
              self.layout_tree,
              self.docstore,
              self.llm_provider
          )

          # Handle collisions, copy file
          dest_path = self._copy_with_collision_handling(
              local_path, dest_folder, name, file_hash
          )

          # Update cache
          self.cache.update_copied(file_hash, dest_path)
