MetadataCache - Document Analysis Cache
=======================================

Location: workflows/metadata_cache.py
Database: ~/Library/Application Support/papersort/metadata.db

Caches document metadata to avoid reprocessing identical files.
Uses SQLite for persistence. See metadata.md for FileMetadata dataclass.


Class: MetadataCache
--------------------

Constructor:
  MetadataCache(db_path: str = None)
    Creates database and tables if they don't exist.
    Default path: ~/Library/Application Support/papersort/metadata.db

Methods:
  get_by_hash(sha256: str) -> FileMetadata | None
    Primary lookup by file content hash.

  exists(sha256: str) -> bool
    Quick existence check.

  save(metadata: FileMetadata)
    Insert or update document record.

  update_copied(sha256: str, dst_uri: str, dst_uri_display: str)
    Mark file as copied, record destination.

  close()
    Close database connection.

Helper:
  compute_sha256(file_path: str) -> str
    Compute SHA256 hash of file contents.


Database Schema
---------------

Table: documents

  sha256 TEXT PRIMARY KEY       -- File content hash (lookup key)
  original_filename TEXT        -- Original filename without path
  file_size INTEGER             -- File size in bytes
  src_uri TEXT                  -- Source URI (gdrive:id:path, local:path, etc.)
  src_uri_display TEXT          -- Human-readable source path
  title TEXT                    -- Document title from LLM
  entity TEXT                   -- Company/person name
  summary TEXT                  -- Brief description
  confidence INTEGER            -- LLM confidence score (1-10)
  reporting_year INTEGER        -- Year the document is about
  document_date TEXT            -- Date on document (YYYY-MM)
  suggested_path TEXT           -- LLM-suggested folder path
  dst_uri TEXT                  -- Destination URI after copy
  dst_uri_display TEXT          -- Human-readable destination path
  copied INTEGER DEFAULT 0      -- 1 if copied to docstore

Index: idx_documents_src_uri ON (src_uri)


URI Format
----------

  {storage_type}:{storage_id}:{path}

  gdrive:{folder_id}:{relative_path}
    Example: gdrive:1aBcDeF:Taxes/2024/return.pdf

  local:{inbox_path}:{relative_path}
    Example: local:/Users/me/inbox:subfolder/doc.pdf

  dropbox:{root_path}:{relative_path}
    Example: dropbox:/Inbox:subfolder/doc.pdf


Behavior
--------

  - Creates DB directory if missing
  - Uses INSERT OR REPLACE for idempotent writes
  - SHA256 is the source of truth for file identity
  - No migration: delete existing cache to reset


Usage Example
-------------

  cache = MetadataCache()

  # Check cache before processing
  existing = cache.get_by_hash(file_hash)
  if existing and not force_update:
      # Use cached metadata
      existing.display(PaperSort.print_right)
  else:
      # Run LLM analysis, get FileMetadata
      metadata = analyze_document(file_path)
      cache.save(metadata)

  # After copying
  cache.update_copied(file_hash, dst_uri, dst_uri_display)

  cache.close()
