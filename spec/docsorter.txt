DocSorter - Document Analysis
=============================

Location: workflows/docsorter.py

DocSorter analyzes PDF documents using an LLM to extract metadata and
suggest a filing location based on the docstore layout.


Class: DocSorter
----------------

Constructor:
  DocSorter(file_path: str)
    - Validates file exists and is a PDF
    - Computes SHA256 hash
    - Loads layout if not already loaded

Class Methods:
  set_layout_content(content: str)
    Set layout from string (e.g., read from storage driver).

  path_exists(path: str) -> bool
    Check if path is valid in layout tree.
    Handles special cases: "By year" (any 4-digit year), "By company" (any name).

  get_by_company_paths() -> List[str]
    Find all paths with "By company" subfolders (for deduplication).

  print_layout()
    Print layout tree to stdout.

Instance Fields (populated by sort()):
  - sha256: str           File content hash
  - title: str            Short document title (max 10 words)
  - year: int             Document year (tax year for tax docs)
  - date: str             Document date (YYYY-MM format)
  - entity: str           Company/organization name
  - suggested_path: str   Where to file in docstore
  - confidence: int       1-10 confidence in suggested path
  - summary: str          Brief description (max 100 words)

Methods:
  sort(llm_provider="mistral") -> bool
    Analyze document with LLM. Returns True on success.
    Uses models/ layer for LLM calls.

  save_to_db(cache: MetadataCache, source: str = None)
    Save metadata to cache.


LLM Integration
---------------

DocSorter uses the models/ layer for LLM calls:

  from models import create_llm
  llm = create_llm(provider)  # "mistral" or "openai"
  llm.analyze_document(pdf_path, prompt) -> dict

The prompt includes:
  1. Static instructions (output format, guidelines)
  2. The docstore layout (valid paths)

The LLM returns structured metadata which is parsed into fields.


Layout Format
-------------

Layout is read from docstore's layout.txt file.

Special markers:
  - "By year": Subfolder for each year (2023, 2024, etc.)
  - "By company": Subfolder for each company name
  - "Other": Catchall for documents without good matches

Validation:
  - Folder names: max 30 chars, alphanumeric + space/hyphen/underscore
  - Must have "---LAYOUT STARTS HERE---" marker
  - Paths suggested by LLM are validated against layout


Error Handling
--------------

  - File not found: Raise FileNotFoundError
  - Invalid file type: Raise ValueError
  - Layout missing/malformed: Raise ValueError with clear message
  - LLM API failure: Retry up to 3 times via models/ layer
  - Invalid path from LLM: Logged, confidence reduced


Usage in Filing Workflow
------------------------

The filing workflow (workflows/filing.py) uses DocSorter:

  1. Download file from inbox to local temp
  2. Check MetadataCache for existing analysis
  3. If not cached (or --update): create DocSorter, call sort()
  4. Save results to cache
  5. Use suggested_path for copy destination
